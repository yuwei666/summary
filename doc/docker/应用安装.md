创建网络

docker 

前面是宿主机路径，后面是容器内路径

  -v /etc/nginx/conf.d:/etc/nginx/conf.d:ro \

## nginx（不推荐使用docker安装）

``` bash
# 拉取镜像 也可以使用精简版本 nginx:alpine
sudo docker pull nginx:1.26

# 先直接运行容器，把需要配置文件复制出来，再加上挂载参数运行容器（如果已有配置请忽略）
sudo docker run -d nginx:1.26

# 将容器nginx.conf文件复制到宿主机（如果已有配置请忽略）
sudo docker cp nginx:/etc/nginx/nginx.conf /data/nginx/conf/nginx.conf
# 将容器conf.d文件夹下内容复制到宿主机
sudo docker cp nginx:/etc/nginx/conf.d /data/nginx/conf/
# 将容器中的html文件夹复制到宿主机
sudo docker cp nginx:/usr/share/nginx/html /data/nginx/

# 修改宿主机/etc/nginx下的权限，这里直接递归赋权了，正常应该是文件夹755，文件644。
# 如果没有权限，那么就走容器内的配置了
sudo chmod -R 755 /etc/nginx

# 运行nginx 
sudo docker run -d \
  --name nginx \
  --restart unless-stopped \
  -p 80:80 -p 443:443 \
  -v /data/nginx/conf/nginx.conf:/etc/nginx/nginx.conf:ro \
  -v /data/nginx/conf/conf.d:/etc/nginx/conf.d:ro \
  -v /data/nginx/html:/usr/share/nginx/html \
  -v /data/nginx/log:/var/log/nginx \
  -v /etc/letsencrypt:/etc/letsencrypt:ro \
  -v /etc/localtime:/etc/localtime:ro \
  -v /etc/timezone:/etc/timezone:ro \
  --memory=512m \
  --cpus=1 \
  --security-opt no-new-privileges \
  nginx:1.26
```

- 80 http端口，443 https端口
- --restart unless-stopped 除非手动停止，否则总是重启
- `:ro` 是挂载卷（volume）时使用的选项，表示 **Read-Only**（只读），表示容器内的进程（如Nginx）只能**读取**这个文件，不能修改或删除它，默认为`:rw`读写
- /etc/localtime:/etc/localtime:ro 同步宿主机时间
- /etc/timezone:/etc/timezone:ro 同步时区配置
- 使用Let's Encrypt自动续期：待补充

nginx.conf

```nginx
user www-data;
worker_processes auto;
pid /run/nginx.pid;

events {
    worker_connections 768;
}

http {
    # 打印真实的文件路径（测试非常好用）
    log_format main '$remote_addr - $remote_user [$time_local] '
                  '"$request" $status $body_bytes_sent '
                  'Actual File: "$request_filename"';
	
    # 打印代理的url
    log_format proxy_trace '$remote_addr - "$request" → '
                         'Proxy: "$scheme://$proxy_host$uri" → '
                        # 'Upstream: "$upstream_addr$upstream_uri" '
                         'Time: $upstream_response_time';

    # 这里是全局配置，也可以写在server中
    # access_log /var/log/nginx/access.log main;
    error_log /var/log/nginx/error.log warn;

    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 1000;
    types_hash_max_size 2048;

    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    include /etc/nginx/conf.d/*.conf;
}
```

conf.d/pacscloud.conf

```nginx
server {
        listen       80;
        server_name  172.16.1.108;

        #location / {
        #    root   html;
        #    index  index.html index.htm;
        #    #    try_files $uri $uri/ /index.html;
        #}

    	# 注意写法，静态资源后面不加/
        location /pacscloud {
        	# 如果想拼上/pacscloud,使用root， 如果想替换，就使用alias，视情况而定
            alias /app/pacscloud/web/dist/;
            try_files $uri $uri/ /index.html;
            index  index.html index.htm;
        	# 打印访问文件真实路径，便于调试
            access_log /var/log/nginx/access.log main;
        }
    
		# 注意写法，代理转发后面加/，否则会出现//xxx/getinfo的情况
        location /pacscloud/prod-api/ {
             proxy_set_header Host $http_host;
             proxy_set_header X-Real-IP $remote_addr;
             proxy_set_header REMOTE-HOST $remote_addr;
             proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
             proxy_pass http://localhost:8082/;
             # 打印代理的url，便于调试
             access_log /var/log/nginx/access.log proxy_trace;
        }

}
```

推荐方式：

```bash
sudo apt update
sudo apt install nginx
sudo systemctl start nginx
# 开机启动
sudo systemctl enable nginx
# 防火墙允许http和https 
sudo ufw allow 'Nginx Full'
```







## nacos

```bash
# 如果不存在配置文件，则需要将内容考出来，否则启动不成功，已存在请忽略
sudo docker run -d \
  --name nacos \
  --restart unless-stopped \
  nacos/nacos-server:v2.3.0

# 如果是文件，则宿主机也需要存在此文件；如果是目录，指令宿主机上级目录即可
sudo docker cp nacos:/home/nacos/logs /data/nacos/
sudo docker cp nacos:/home/nacos/data /data/nacos/
sudo docker cp nacos:/home/nacos/conf /data/nacos/

# 启动docker
docker run -d \
  --name nacos \
  --restart unless-stopped \
  --network rld-network \
  -p 8848:8848 \
  -p 9848:9848 \
  -p 9849:9849 \
  -e MODE=standalone \
  -e NACOS_SERVER_IP=172.16.1.108 \
  -e TZ=Asia/Shanghai \
  -v /etc/localtime:/etc/localtime:ro \
  -v /etc/timezone:/etc/timezone:ro \
  -v /data/nacos/logs:/home/nacos/logs \
  -v /data/nacos/data:/home/nacos/data \
  -v /data/nacos/conf:/home/nacos/conf \
  --memory=3g \
  --cpus=1 \
  --security-opt no-new-privileges \
  --ulimit nofile=65536:65536 \
  nacos/nacos-server:v2.3.0


docker run -d \
  --name nacos \
  --restart unless-stopped \  # 自动重启
  --network rld-network \  # 自定义网络
  -p 8848:8848 \
  -p 9848:9848 \  # Nacos 2.0+ 需要额外端口
  -p 9849:9849 \  # Nacos 2.0+ 集群通信端口
  -e MODE=standalone \  # 单机模式（集群模式需修改）
  -e NACOS_SERVER_IP=192.168.1.100 \  # 明确指定IP
  -e JVM_XMS=1g \  # JVM最小内存
  -e JVM_XMX=2g \  # JVM最大内存
  -e TZ=Asia/Shanghai \  # 时区
  -v /etc/localtime:/etc/localtime:ro \
  -v /etc/timezone:/etc/timezone:ro \
  -v /data/nacos/logs:/home/nacos/logs \  # 日志持久化
  -v /data/nacos/data:/home/nacos/data \  # 数据持久化
  -v /data/nacos/conf:/home/nacos/conf \  # 自定义配置
  --memory=3g \  # 内存限制
  --cpus=1 \  # CPU限制
  --security-opt no-new-privileges \  # 安全限制
  --ulimit nofile=65536:65536 \  # 文件描述符限制
  nacos/nacos-server:v2.3.0  # 指定稳定版本
```

## mysql

```bash
docker run -d \
  --name mysql2 \
  --restart always \
  -p 3307:3306 \
  -v /mydata/mysql/conf/my.cnf:/etc/mysql/my.cnf \
  -v /mydata/mysql/data:/var/lib/mysql \
  -v /mydata/mysql/log:/var/log/mysql \
  -v /mydata/mysql/conf/conf.d:/etc/mysql/conf.d \
  -e TZ=Asia/Shanghai \
  -e MYSQL_ROOT_PASSWORD=Data!@Pass \
  mysql:8.0


docker run -d \
  --name mysql2 \
  --restart unless-stopped \
  --network rld-network \
  -p 3306:3306 \
  -e MYSQL_ROOT_PASSWORD='root' \
  -e MYSQL_DATABASE=pacsdicom \
  -e MYSQL_USER=pacs \
  -e MYSQL_PASSWORD='Pacs@123' \
  -e TZ=Asia/Shanghai \
  -e MYSQL_INITDB_SKIP_TZINFO=1 \
  -e MYSQL_DEFAULT_AUTHENTICATION_PLUGIN=mysql_native_password \
  -e MYSQL_LOG_CONSOLE=true \
  -v /data/mysql/conf:/etc/mysql/conf.d \
  -v /data/mysql/data:/var/lib/mysql \
  -v /data/mysql/logs:/var/log/mysql \
  -v /etc/localtime:/etc/localtime:ro \
  --memory=4g \
  --cpus=2 \
  --security-opt no-new-privileges \
  --ulimit nofile=65535:65535 \
  mysql:8.0.21 \
  --character-set-server=utf8mb4 \
  --collation-server=utf8mb4_unicode_ci \
  --max_connections=500 \
  --innodb_buffer_pool_size=2G \
  --slow_query_log=1 \
  --long_query_time=2
```

## **fastdfs**

第三方个人开发者（delron），推荐使用season/fastdfs，/data/fastdfs/storage  挂载的路径需要有足够的空间，空间大小查看

```bash
df -h | grep -v '^tmpfs\|^overlay\|^none'
```

8888端口用于 FastDFS 提供的文件访问服务，23000用于提供文件存储和访问服务的端口

```bash
sudo docker network create fastdfs-net

-- 追踪线程
sudo docker run -d \
  --name fastdfs-tracker \
  --network rld-network \
  --restart unless-stopped \
  -v /var/fastdfs/tracker:/var/fdfs \
  -v tracker_conf:/etc/fdfs \
  -p 22122:22122 \
  -e TZ=Asia/Shanghai \
  -e FASTDFS_PATH=/opt/fdfs \
  -e FASTDFS_BASE_PATH=/var/fdfs \
  -e PORT= \
  -e GROUP_NAME= \
  -e TRACKER_SERVER= \
  -w /tmp/nginx/nginx-1.12.2 \
  delron/fastdfs \
  tracker

-- 可以使用
sudo docker run -d \
  --name fastdfs-storage \
  --network rld-network \
  --restart unless-stopped \
  -v /data/fastdfs/storage:/var/fdfs \
  -p 8888:8888 \
  -p 23000:23000 \
  -e TZ=Asia/Shanghai \
  -e TRACKER_SERVER=fastdfs-tracker:22122 \
  -e GROUP_NAME=group1 \
  -e FASTDFS_PATH=/opt/fdfs \
  -e FASTDFS_BASE_PATH=/var/fdfs \
  -e STORAGE_IP=172.16.1.108 \
  delron/fastdfs \
  storage


```

## redis

```bash
docker run -d --name redis -p 6379:6379 redis:7.4

# 如果是文件，则宿主机也需要存在此文件；如果是目录，指令宿主机上级目录即可
sudo docker cp redis:/data/redis/data /data
sudo docker cp redis:/data/redis/conf/redis.conf /usr/local/etc/redis/redis.conf
sudo docker cp redis:/data/redis/logs /logs

docker run -d \
  --name redis \
  --restart unless-stopped \
  --network rld-network \
  -p 6379:6379 \
  -v /data/redis/data:/data \
  -v /data/redis/conf/redis.conf:/usr/local/etc/redis/redis.conf \
  -v /data/redis/logs:/logs \
  -v /etc/localtime:/etc/localtime:ro \
  -e TZ=Asia/Shanghai \
  --memory=4g \
  --cpus=2 \
  --security-opt no-new-privileges \
  --ulimit nofile=65535:65535 \
  redis:7.4 redis-server --requirepass Philips@2022 --bind 0.0.0.0

docker run -d \
  --name redis \
  --hostname redis-node1 \
  --restart unless-stopped \
  --network rld-network \
  --ip 172.16.1.108 \  # 固定IP（需与网络子网匹配）
  -p 6379:6379 \
  -p 16379:16379 \  # Redis集群总线端口
  -v /data/redis/data:/data \  # 数据持久化
  -v /data/redis/conf/redis.conf:/usr/local/etc/redis/redis.conf \  # 配置文件
  -v /data/redis/logs:/logs \  # 日志目录
  -v /etc/localtime:/etc/localtime:ro \  # 时间同步
  -e TZ=Asia/Shanghai \
  --memory=4g \
  --cpus=2 \
  --security-opt no-new-privileges \
  --ulimit nofile=65535:65535 \
  redis:7.2-alpine \  # 指定稳定版本
  redis-server /usr/local/etc/redis/redis.conf --requirepass "Strong@RedisPass123" --appendonly yes --maxmemory 3gb --maxmemory-policy volatile-lru
```

## gitlab

前提：设置 DNS，配置nginx

创建目录

```bash
mkdir /srv/gitlab/config
mkdir /srv/gitlab/logs
mkdir /srv/gitlab/data
```

备份原容器

```

```

启动命令

```bash
docker run -d \
  --name gitlab \
  -p 800:80 \
  -p 4430:443 \
  -p 220:22 \
  --restart always \
  --volume /srv/gitlab/config:/etc/gitlab \
  --volume /srv/gitlab/logs:/var/log/gitlab \
  --volume /srv/gitlab/data:/var/opt/gitlab \
  gitlab/gitlab-ce:latest
  
  
  docker run --detach \
  --hostname gitlab.zyspace.com.cn \
  --publish 8929:80 --publish 8222:22 \
  --name gitlab \
  --restart always \
  --volume /srv/gitlab/config:/etc/gitlab \
  --volume /srv/gitlab/logs:/var/log/gitlab \
  --volume /srv/gitlab/data:/var/opt/gitlab \
  gitlab/gitlab-ce:latest
```

```bash
docker run -d \
  --name zealous_clarke \
  -p 800:80 \
  -p 4430:443 \
  -p 220:22 \
  -v /var/lib/docker/volumes/6a7d745eb1cea11d2c0d92456a761323becc84547f53156b0594004b6f2c26d1/_data:/etc/gitlab \
  -v /var/lib/docker/volumes/360593eaf17d40948397336a6f85873ad5fedaecda65254b43725d59e6816e0c/_data:/var/log/gitlab \
  -v /var/lib/docker/volumes/4b0b7afe170eb7b746009ef7a6cee9589454c1693050eb0e7f5ced757825d69b/_data:/var/opt/gitlab \
  --restart always \
  gitlab/gitlab-ce

```



## odoo

odoo是一个开源的ERP系统

```bash
sudo docker run -d --name db --network odoo-net \
  -e POSTGRES_USER=odoo -e POSTGRES_PASSWORD='P@ssword' -e POSTGRES_DB=postgres \
  -v /data/odoo/pgdata:/var/lib/postgresql/data \
  postgres:15

sudo docker run -d --name odoo --network odoo-net --privileged \
  -p 8069:8069 \
  -e HOST=db -e PORT=5432 -e USER=odoo -e PASSWORD='P@ssword' \
  odoo
```





