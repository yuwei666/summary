åˆ›å»ºç½‘ç»œ

docker 

å‰é¢æ˜¯å®¿ä¸»æœºè·¯å¾„ï¼Œåé¢æ˜¯å®¹å™¨å†…è·¯å¾„

  -v /etc/nginx/conf.d:/etc/nginx/conf.d:ro \

## nginxï¼ˆä¸æ¨èä½¿ç”¨dockerå®‰è£…ï¼‰

``` bash
# æ‹‰å–é•œåƒ ä¹Ÿå¯ä»¥ä½¿ç”¨ç²¾ç®€ç‰ˆæœ¬ nginx:alpine
sudo docker pull nginx:1.26

# å…ˆç›´æ¥è¿è¡Œå®¹å™¨ï¼ŒæŠŠéœ€è¦é…ç½®æ–‡ä»¶å¤åˆ¶å‡ºæ¥ï¼Œå†åŠ ä¸ŠæŒ‚è½½å‚æ•°è¿è¡Œå®¹å™¨ï¼ˆå¦‚æœå·²æœ‰é…ç½®è¯·å¿½ç•¥ï¼‰
sudo docker run -d nginx:1.26

# å°†å®¹å™¨nginx.confæ–‡ä»¶å¤åˆ¶åˆ°å®¿ä¸»æœºï¼ˆå¦‚æœå·²æœ‰é…ç½®è¯·å¿½ç•¥ï¼‰
sudo docker cp nginx:/etc/nginx/nginx.conf /data/nginx/conf/nginx.conf
# å°†å®¹å™¨conf.dæ–‡ä»¶å¤¹ä¸‹å†…å®¹å¤åˆ¶åˆ°å®¿ä¸»æœº
sudo docker cp nginx:/etc/nginx/conf.d /data/nginx/conf/
# å°†å®¹å™¨ä¸­çš„htmlæ–‡ä»¶å¤¹å¤åˆ¶åˆ°å®¿ä¸»æœº
sudo docker cp nginx:/usr/share/nginx/html /data/nginx/

# ä¿®æ”¹å®¿ä¸»æœº/etc/nginxä¸‹çš„æƒé™ï¼Œè¿™é‡Œç›´æ¥é€’å½’èµ‹æƒäº†ï¼Œæ­£å¸¸åº”è¯¥æ˜¯æ–‡ä»¶å¤¹755ï¼Œæ–‡ä»¶644ã€‚
# å¦‚æœæ²¡æœ‰æƒé™ï¼Œé‚£ä¹ˆå°±èµ°å®¹å™¨å†…çš„é…ç½®äº†
sudo chmod -R 755 /etc/nginx

# è¿è¡Œnginx 
sudo docker run -d \
  --name nginx \
  --restart unless-stopped \
  -p 80:80 -p 443:443 \
  -v /data/nginx/conf/nginx.conf:/etc/nginx/nginx.conf:ro \
  -v /data/nginx/conf/conf.d:/etc/nginx/conf.d:ro \
  -v /data/nginx/html:/usr/share/nginx/html \
  -v /data/nginx/log:/var/log/nginx \
  -v /etc/letsencrypt:/etc/letsencrypt:ro \
  -v /etc/localtime:/etc/localtime:ro \
  -v /etc/timezone:/etc/timezone:ro \
  --memory=512m \
  --cpus=1 \
  --security-opt no-new-privileges \
  nginx:1.26
```

- 80 httpç«¯å£ï¼Œ443 httpsç«¯å£
- --restart unless-stopped é™¤éæ‰‹åŠ¨åœæ­¢ï¼Œå¦åˆ™æ€»æ˜¯é‡å¯
- `:ro` æ˜¯æŒ‚è½½å·ï¼ˆvolumeï¼‰æ—¶ä½¿ç”¨çš„é€‰é¡¹ï¼Œè¡¨ç¤º **Read-Only**ï¼ˆåªè¯»ï¼‰ï¼Œè¡¨ç¤ºå®¹å™¨å†…çš„è¿›ç¨‹ï¼ˆå¦‚Nginxï¼‰åªèƒ½**è¯»å–**è¿™ä¸ªæ–‡ä»¶ï¼Œä¸èƒ½ä¿®æ”¹æˆ–åˆ é™¤å®ƒï¼Œé»˜è®¤ä¸º`:rw`è¯»å†™
- /etc/localtime:/etc/localtime:ro åŒæ­¥å®¿ä¸»æœºæ—¶é—´
- /etc/timezone:/etc/timezone:ro åŒæ­¥æ—¶åŒºé…ç½®
- ä½¿ç”¨Let's Encryptè‡ªåŠ¨ç»­æœŸï¼šå¾…è¡¥å……

nginx.conf

```nginx
user www-data;
worker_processes auto;
pid /run/nginx.pid;

events {
    worker_connections 768;
}

http {
    # æ‰“å°çœŸå®çš„æ–‡ä»¶è·¯å¾„ï¼ˆæµ‹è¯•éå¸¸å¥½ç”¨ï¼‰
    log_format main '$remote_addr - $remote_user [$time_local] '
                  '"$request" $status $body_bytes_sent '
                  'Actual File: "$request_filename"';
	
    # æ‰“å°ä»£ç†çš„url
    log_format proxy_trace '$remote_addr - "$request" â†’ '
                         'Proxy: "$scheme://$proxy_host$uri" â†’ '
                        # 'Upstream: "$upstream_addr$upstream_uri" '
                         'Time: $upstream_response_time';

    # è¿™é‡Œæ˜¯å…¨å±€é…ç½®ï¼Œä¹Ÿå¯ä»¥å†™åœ¨serverä¸­
    # access_log /var/log/nginx/access.log main;
    error_log /var/log/nginx/error.log warn;

    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 1000;
    types_hash_max_size 2048;

    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    include /etc/nginx/conf.d/*.conf;
}
```

conf.d/pacscloud.conf

```nginx
server {
        listen       80;
        server_name  172.16.1.108;

        #location / {
        #    root   html;
        #    index  index.html index.htm;
        #    #    try_files $uri $uri/ /index.html;
        #}

    	# æ³¨æ„å†™æ³•ï¼Œé™æ€èµ„æºåé¢ä¸åŠ /
        location /pacscloud {
        	# å¦‚æœæƒ³æ‹¼ä¸Š/pacscloud,ä½¿ç”¨rootï¼Œ å¦‚æœæƒ³æ›¿æ¢ï¼Œå°±ä½¿ç”¨aliasï¼Œè§†æƒ…å†µè€Œå®š
            alias /app/pacscloud/web/dist/;
            try_files $uri $uri/ /index.html;
            index  index.html index.htm;
        	# æ‰“å°è®¿é—®æ–‡ä»¶çœŸå®è·¯å¾„ï¼Œä¾¿äºè°ƒè¯•
            access_log /var/log/nginx/access.log main;
        }
    
		# æ³¨æ„å†™æ³•ï¼Œä»£ç†è½¬å‘åé¢åŠ /ï¼Œå¦åˆ™ä¼šå‡ºç°//xxx/getinfoçš„æƒ…å†µ
        location /pacscloud/prod-api/ {
             proxy_set_header Host $http_host;
             proxy_set_header X-Real-IP $remote_addr;
             proxy_set_header REMOTE-HOST $remote_addr;
             proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
             proxy_pass http://localhost:8082/;
             # æ‰“å°ä»£ç†çš„urlï¼Œä¾¿äºè°ƒè¯•
             access_log /var/log/nginx/access.log proxy_trace;
        }

}
```

æ¨èæ–¹å¼ï¼š

```bash
sudo apt update
sudo apt install nginx
sudo systemctl start nginx
# å¼€æœºå¯åŠ¨
sudo systemctl enable nginx
# é˜²ç«å¢™å…è®¸httpå’Œhttps 
sudo ufw allow 'Nginx Full'
```







## nacos

```bash
# å¦‚æœä¸å­˜åœ¨é…ç½®æ–‡ä»¶ï¼Œåˆ™éœ€è¦å°†å†…å®¹è€ƒå‡ºæ¥ï¼Œå¦åˆ™å¯åŠ¨ä¸æˆåŠŸï¼Œå·²å­˜åœ¨è¯·å¿½ç•¥
sudo docker run -d \
  --name nacos \
  --restart unless-stopped \
  nacos/nacos-server:v2.3.0

# å¦‚æœæ˜¯æ–‡ä»¶ï¼Œåˆ™å®¿ä¸»æœºä¹Ÿéœ€è¦å­˜åœ¨æ­¤æ–‡ä»¶ï¼›å¦‚æœæ˜¯ç›®å½•ï¼ŒæŒ‡ä»¤å®¿ä¸»æœºä¸Šçº§ç›®å½•å³å¯
sudo docker cp nacos:/home/nacos/logs /data/nacos/
sudo docker cp nacos:/home/nacos/data /data/nacos/
sudo docker cp nacos:/home/nacos/conf /data/nacos/

# å¯åŠ¨docker
docker run -d \
  --name nacos \
  --restart unless-stopped \
  --network rld-network \
  -p 8848:8848 \
  -p 9848:9848 \
  -p 9849:9849 \
  -e MODE=standalone \
  -e NACOS_SERVER_IP=172.16.1.108 \
  -e TZ=Asia/Shanghai \
  -v /etc/localtime:/etc/localtime:ro \
  -v /etc/timezone:/etc/timezone:ro \
  -v /data/nacos/logs:/home/nacos/logs \
  -v /data/nacos/data:/home/nacos/data \
  -v /data/nacos/conf:/home/nacos/conf \
  --memory=3g \
  --cpus=1 \
  --security-opt no-new-privileges \
  --ulimit nofile=65536:65536 \
  nacos/nacos-server:v2.3.0


docker run -d \
  --name nacos \
  --restart unless-stopped \  # è‡ªåŠ¨é‡å¯
  --network rld-network \  # è‡ªå®šä¹‰ç½‘ç»œ
  -p 8848:8848 \
  -p 9848:9848 \  # Nacos 2.0+ éœ€è¦é¢å¤–ç«¯å£
  -p 9849:9849 \  # Nacos 2.0+ é›†ç¾¤é€šä¿¡ç«¯å£
  -e MODE=standalone \  # å•æœºæ¨¡å¼ï¼ˆé›†ç¾¤æ¨¡å¼éœ€ä¿®æ”¹ï¼‰
  -e NACOS_SERVER_IP=192.168.1.100 \  # æ˜ç¡®æŒ‡å®šIP
  -e JVM_XMS=1g \  # JVMæœ€å°å†…å­˜
  -e JVM_XMX=2g \  # JVMæœ€å¤§å†…å­˜
  -e TZ=Asia/Shanghai \  # æ—¶åŒº
  -v /etc/localtime:/etc/localtime:ro \
  -v /etc/timezone:/etc/timezone:ro \
  -v /data/nacos/logs:/home/nacos/logs \  # æ—¥å¿—æŒä¹…åŒ–
  -v /data/nacos/data:/home/nacos/data \  # æ•°æ®æŒä¹…åŒ–
  -v /data/nacos/conf:/home/nacos/conf \  # è‡ªå®šä¹‰é…ç½®
  --memory=3g \  # å†…å­˜é™åˆ¶
  --cpus=1 \  # CPUé™åˆ¶
  --security-opt no-new-privileges \  # å®‰å…¨é™åˆ¶
  --ulimit nofile=65536:65536 \  # æ–‡ä»¶æè¿°ç¬¦é™åˆ¶
  nacos/nacos-server:v2.3.0  # æŒ‡å®šç¨³å®šç‰ˆæœ¬
```

## mysql

```bash
docker run -d \
  --name mysql2 \
  --restart always \
  -p 3307:3306 \
  -v /mydata/mysql/conf/my.cnf:/etc/mysql/my.cnf \
  -v /mydata/mysql/data:/var/lib/mysql \
  -v /mydata/mysql/log:/var/log/mysql \
  -v /mydata/mysql/conf/conf.d:/etc/mysql/conf.d \
  -e TZ=Asia/Shanghai \
  -e MYSQL_ROOT_PASSWORD=Data!@Pass \
  mysql:8.0


docker run -d \
  --name mysql2 \
  --restart unless-stopped \
  --network rld-network \
  -p 3306:3306 \
  -e MYSQL_ROOT_PASSWORD='root' \
  -e MYSQL_DATABASE=pacsdicom \
  -e MYSQL_USER=pacs \
  -e MYSQL_PASSWORD='Pacs@123' \
  -e TZ=Asia/Shanghai \
  -e MYSQL_INITDB_SKIP_TZINFO=1 \
  -e MYSQL_DEFAULT_AUTHENTICATION_PLUGIN=mysql_native_password \
  -e MYSQL_LOG_CONSOLE=true \
  -v /data/mysql/conf:/etc/mysql/conf.d \
  -v /data/mysql/data:/var/lib/mysql \
  -v /data/mysql/logs:/var/log/mysql \
  -v /etc/localtime:/etc/localtime:ro \
  --memory=4g \
  --cpus=2 \
  --security-opt no-new-privileges \
  --ulimit nofile=65535:65535 \
  mysql:8.0.21 \
  --character-set-server=utf8mb4 \
  --collation-server=utf8mb4_unicode_ci \
  --max_connections=500 \
  --innodb_buffer_pool_size=2G \
  --slow_query_log=1 \
  --long_query_time=2
```

## **fastdfs**

ç¬¬ä¸‰æ–¹ä¸ªäººå¼€å‘è€…ï¼ˆdelronï¼‰ï¼Œæ¨èä½¿ç”¨season/fastdfsï¼Œ/data/fastdfs/storage  æŒ‚è½½çš„è·¯å¾„éœ€è¦æœ‰è¶³å¤Ÿçš„ç©ºé—´ï¼Œç©ºé—´å¤§å°æŸ¥çœ‹

```bash
df -h | grep -v '^tmpfs\|^overlay\|^none'
```

8888ç«¯å£ç”¨äº FastDFS æä¾›çš„æ–‡ä»¶è®¿é—®æœåŠ¡ï¼Œ23000ç”¨äºæä¾›æ–‡ä»¶å­˜å‚¨å’Œè®¿é—®æœåŠ¡çš„ç«¯å£

```bash
sudo docker network create fastdfs-net

-- è¿½è¸ªçº¿ç¨‹
sudo docker run -d \
  --name fastdfs-tracker \
  --network rld-network \
  --restart unless-stopped \
  -v /var/fastdfs/tracker:/var/fdfs \
  -v tracker_conf:/etc/fdfs \
  -p 22122:22122 \
  -e TZ=Asia/Shanghai \
  -e FASTDFS_PATH=/opt/fdfs \
  -e FASTDFS_BASE_PATH=/var/fdfs \
  -e PORT= \
  -e GROUP_NAME= \
  -e TRACKER_SERVER= \
  -w /tmp/nginx/nginx-1.12.2 \
  delron/fastdfs \
  tracker

-- å¯ä»¥ä½¿ç”¨
sudo docker run -d \
  --name fastdfs-storage \
  --network rld-network \
  --restart unless-stopped \
  -v /data/fastdfs/storage:/var/fdfs \
  -p 8888:8888 \
  -p 23000:23000 \
  -e TZ=Asia/Shanghai \
  -e TRACKER_SERVER=fastdfs-tracker:22122 \
  -e GROUP_NAME=group1 \
  -e FASTDFS_PATH=/opt/fdfs \
  -e FASTDFS_BASE_PATH=/var/fdfs \
  -e STORAGE_IP=172.16.1.108 \
  delron/fastdfs \
  storage


```

## redis

```bash
docker run -d --name redis -p 6379:6379 redis:7.4

# å¦‚æœæ˜¯æ–‡ä»¶ï¼Œåˆ™å®¿ä¸»æœºä¹Ÿéœ€è¦å­˜åœ¨æ­¤æ–‡ä»¶ï¼›å¦‚æœæ˜¯ç›®å½•ï¼ŒæŒ‡ä»¤å®¿ä¸»æœºä¸Šçº§ç›®å½•å³å¯
sudo docker cp redis:/data/redis/data /data
sudo docker cp redis:/data/redis/conf/redis.conf /usr/local/etc/redis/redis.conf
sudo docker cp redis:/data/redis/logs /logs

docker run -d \
  --name redis \
  --restart unless-stopped \
  --network rld-network \
  -p 6379:6379 \
  -v /data/redis/data:/data \
  -v /data/redis/conf/redis.conf:/usr/local/etc/redis/redis.conf \
  -v /data/redis/logs:/logs \
  -v /etc/localtime:/etc/localtime:ro \
  -e TZ=Asia/Shanghai \
  --memory=4g \
  --cpus=2 \
  --security-opt no-new-privileges \
  --ulimit nofile=65535:65535 \
  redis:7.4 redis-server --requirepass Philips@2022 --bind 0.0.0.0

docker run -d \
  --name redis \
  --hostname redis-node1 \
  --restart unless-stopped \
  --network rld-network \
  --ip 172.16.1.108 \  # å›ºå®šIPï¼ˆéœ€ä¸ç½‘ç»œå­ç½‘åŒ¹é…ï¼‰
  -p 6379:6379 \
  -p 16379:16379 \  # Redisé›†ç¾¤æ€»çº¿ç«¯å£
  -v /data/redis/data:/data \  # æ•°æ®æŒä¹…åŒ–
  -v /data/redis/conf/redis.conf:/usr/local/etc/redis/redis.conf \  # é…ç½®æ–‡ä»¶
  -v /data/redis/logs:/logs \  # æ—¥å¿—ç›®å½•
  -v /etc/localtime:/etc/localtime:ro \  # æ—¶é—´åŒæ­¥
  -e TZ=Asia/Shanghai \
  --memory=4g \
  --cpus=2 \
  --security-opt no-new-privileges \
  --ulimit nofile=65535:65535 \
  redis:7.2-alpine \  # æŒ‡å®šç¨³å®šç‰ˆæœ¬
  redis-server /usr/local/etc/redis/redis.conf --requirepass "Strong@RedisPass123" --appendonly yes --maxmemory 3gb --maxmemory-policy volatile-lru
```

## gitlab

å‰æï¼šè®¾ç½® DNSï¼Œé…ç½®nginx

åˆ›å»ºç›®å½•

```bash
mkdir /srv/gitlab/config
mkdir /srv/gitlab/logs
mkdir /srv/gitlab/data
```

å¯åŠ¨å‘½ä»¤

```bash
docker run -d \
  --name gitlab \
  -p 800:80 \
  -p 4430:443 \
  -p 220:22 \
  --restart always \
  --volume /srv/gitlab/config:/etc/gitlab \
  --volume /srv/gitlab/logs:/var/log/gitlab \
  --volume /srv/gitlab/data:/var/opt/gitlab \
  gitlab/gitlab-ce:latest
  
  
  docker run --detach \
  --hostname gitlab.zyspace.com.cn \
  --publish 8929:80 --publish 8222:22 \
  --name gitlab \
  --restart always \
  --volume /srv/gitlab/config:/etc/gitlab \
  --volume /srv/gitlab/logs:/var/log/gitlab \
  --volume /srv/gitlab/data:/var/opt/gitlab \
  gitlab/gitlab-ce:latest
```

### gitlab runner

å‡†å¤‡å·¥ä½œ

```bash
# gitlab runnerç›´æ¥åœ¨å®¿ä¸»æœºå®‰è£…ã€‚ä¸å»ºè®®ä½¿ç”¨å®¹å™¨å®‰è£…ï¼Œè¿˜éœ€è¦æŒ‚è½½ï¼Œå¾ˆéº»çƒ¦
# 1. æ·»åŠ å®˜æ–¹ yum æº
curl -L "https://packages.gitlab.com/install/repositories/runner/gitlab-runner/script.rpm.sh" | sudo bash
# 2. ç›´æ¥ yum å®‰è£…
yum install gitlab-runner

# å®‰è£…æˆåŠŸåï¼Œæ³¨å†Œ
gitlab-runner register
æ³¨æ„ï¼šè§£é‡Šå™¨ä½¿ç”¨shellï¼ˆgitlabå’Œç›®æ ‡éƒ¨ç½²åœ¨æ˜¯åŒä¸€å°æœåŠ¡å™¨ï¼‰/docker ï¼ˆéåŒä¸€å°ï¼‰
	tagå’Œyamlä¸­çš„tagè¦å¯¹åº”ã€‚
# å®‰è£…maven
cd /usr/local
wget https://dlcdn.apache.org/maven/maven-3/3.9.11/binaries/apache-maven-3.9.11-bin.tar.gz
tar -zxvf apache-maven-3.9.11-bin.tar.gz
mv apache-maven-3.9.11 maven

# å®‰è£…jdk11 ï¼ˆä¾æ®é¡¹ç›®è€Œå®šï¼‰
wget https://repo.huaweicloud.com/java/jdk/11.0.2+7/jdk-11.0.2_linux-x64_bin.tar.gz
tar -zxvf jdk-11.0.2_linux-x64_bin.tar.gz

# é…ç½®ç¯å¢ƒå˜é‡
vi /etc/profile
# åœ¨æ–‡ä»¶æœ€æœ«å°¾æ·»åŠ ä»¥ä¸‹å†…å®¹ï¼š
export JAVA_HOME=/usr/local/jdk-11.0.2
export CLASSPATH=$:CLASSPATH:$JAVA_HOME/lib/
export PATH=$JAVA_HOME/bin:$PATH

export M2_HOME=/usr/local/maven
export PATH=$PATH:$M2_HOME/bin
# ç«‹åˆ»è®©é…ç½®ç”Ÿæ•ˆ
source /etc/profile

# æµ‹è¯•
[root@iZ2zegu3kg8tnwlziuninrZ jdk-11.0.2]# mvn -v
Apache Maven 3.9.11 (3e54c93a704957b63ee3494413a2b544fd3d825b)
Maven home: /usr/local/maven
Java version: 11.0.2, vendor: Oracle Corporation, runtime: /usr/local/jdk-11.0.2
Default locale: en_US, platform encoding: UTF-8
OS name: "linux", version: "4.18.0-305.3.1.el8.x86_64", arch: "amd64", family: "unix"

# é…ç½®é˜¿é‡Œäº‘mavené•œåƒ
mkdir -p /usr/local/maven/repository
vi /usr/local/maven/conf/settings.xml
```

```xml
<?xml version="1.0" encoding="UTF-8"?>

<settings xmlns="http://maven.apache.org/SETTINGS/1.2.0"
          xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
          xsi:schemaLocation="http://maven.apache.org/SETTINGS/1.2.0 https://maven.apache.org/xsd/settings-1.2.0.xsd">

  <localRepository>/usr/local/maven/repository</localRepository>

  <pluginGroups></pluginGroups>
  <proxies></proxies>
  <servers></servers>
  <mirrors>
    <mirror>
      <id>aliyunmaven</id>
      <mirrorOf>*</mirrorOf>
      <name>é˜¿é‡Œäº‘å…¬å…±ä»“åº“</name>
      <url>https://maven.aliyun.com/repository/public</url>
    </mirror>
  </mirrors>

  <profiles></profiles>
</settings>
```

```bash
# å®‰è£…åä¼šæ–°å»ºä¸€ä¸ªæ™®é€šç”¨æˆ·gitlab-runnerï¼Œéœ€è¦ç»™è¿™ä¸ªç”¨æˆ·èµ‹æƒï¼Œå…è®¸ä½¿ç”¨dockerå‘½ä»¤
usermod -aG docker gitlab-runner
# å¦‚æœåœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ä¼šå¯¹éœ€è¦æƒé™çš„ç›®å½•è¿›è¡Œæ“ä½œï¼Œä¹Ÿéœ€è¦èµ‹æƒ
```

```yaml
variables:
  # === 1. ç¯å¢ƒé…ç½® (åŸºäºä½ æä¾›çš„ mvn -v è¾“å‡º) ===
  # æ˜¾å¼æŒ‡å®šè·¯å¾„ï¼Œç¡®ä¿ Runner 100% èƒ½æ‰¾åˆ°å‘½ä»¤
  JAVA_HOME: "/usr/local/jdk-11.0.2"
  M2_HOME: "/usr/local/maven"

  # === 2. éƒ¨ç½²é…ç½® (è¯·æ ¹æ®å®é™…æƒ…å†µå¾®è°ƒ) ===
  # å®¿ä¸»æœºä¸Šç”¨äºå­˜æ”¾ Jar åŒ…çš„ç›®å½• (å°±æ˜¯ä½  Docker -v æŒ‚è½½çš„é‚£ä¸ªç›®å½•)
  DEPLOY_PATH: "/app/xinyi_healthy/erp"

  # ä½ çš„ ERP å®¹å™¨åç§°
  CONTAINER_NAME: "jsh_erp"

  # ç”Ÿæˆçš„ Jar åŒ…æ–‡ä»¶åå‰ç¼€
  JAR_PREFIX: "jsh_erp"

stages:
  - deploy_all_in_one

# === ä¸»ä»»åŠ¡ï¼šæ„å»ºå¹¶ç›´æ¥éƒ¨ç½² ===
build_and_deploy:
  stage: deploy_all_in_one
  tags:
    # å¿…é¡»ä¸æ³¨å†Œ Runner æ—¶å¡«çš„ tag ä¸€è‡´
    - xinyi_erp

  # ä½¿ç”¨ | å¼€å¯å¤šè¡Œè„šæœ¬æ¨¡å¼
  script: |
    # --- æ­¥éª¤ 0: æ³¨å…¥ç¯å¢ƒå˜é‡ (æœ€å…³é”®çš„ä¸€æ­¥) ---
    export PATH=$JAVA_HOME/bin:$M2_HOME/bin:$PATH
    
    echo "ğŸ” ç¯å¢ƒæ£€æŸ¥:"
    java -version
    mvn -v
    
    # --- æ­¥éª¤ 1: ç¼–è¯‘æ‰“åŒ… ---
    echo "ğŸš€ å¼€å§‹ç¼–è¯‘æ‰“åŒ…..."
    # è·³è¿‡å•å…ƒæµ‹è¯•ï¼ŒåŠ å¿«æ„å»ºé€Ÿåº¦
    mvn clean package -Dmaven.test.skip=true
    
    # --- æ­¥éª¤ 2: æŸ¥æ‰¾æ„å»ºäº§ç‰© ---
    echo "ğŸ“¦ æ­£åœ¨æŸ¥æ‰¾ç”Ÿæˆçš„ Jar åŒ…..."
    # æŸ¥æ‰¾ target ç›®å½•ä¸‹ä»¥ JAR_PREFIX å¼€å¤´çš„æ–‡ä»¶
    NEW_JAR=$(find target -name "${JAR_PREFIX}*.jar" | head -n 1)
    
    if [ -z "$NEW_JAR" ]; then 
      echo "âŒ é”™è¯¯: æœªæ‰¾åˆ° Jar åŒ…ï¼Œæ„å»ºå¤±è´¥ï¼"
      exit 1
    fi
    echo "âœ… æ‰¾åˆ°æ–‡ä»¶: $NEW_JAR"
    
    # --- æ­¥éª¤ 3: éƒ¨ç½²æ–‡ä»¶ ---
    echo "ğŸšš æ­£åœ¨éƒ¨ç½²åˆ°: $DEPLOY_PATH"
    
    # å¦‚æœç›®æ ‡ç›®å½•ä¸å­˜åœ¨ï¼Œå°è¯•åˆ›å»º (éœ€è¦ gitlab-runner æœ‰æƒé™)
    if [ ! -d "$DEPLOY_PATH" ]; then
      echo "âš ï¸ ç›®å½•ä¸å­˜åœ¨ï¼Œå°è¯•åˆ›å»º..."
      mkdir -p "$DEPLOY_PATH"
    fi
    
    # å¤‡ä»½æ—§åŒ… (å¯é€‰)
    if [ -f "$DEPLOY_PATH/jshERP-boot.jar" ]; then 
      mv "$DEPLOY_PATH/jshERP-boot.jar" "$DEPLOY_PATH/jshERP-boot.jar.bak"
    fi
    
    # å¤åˆ¶æ–°åŒ…å¹¶é‡å‘½åä¸ºå›ºå®šåç§°
    cp -f $NEW_JAR "$DEPLOY_PATH/jshERP-boot.jar"
    
    # --- æ­¥éª¤ 4: é‡å¯æœåŠ¡ ---
    echo "ğŸ”„ é‡å¯ Docker å®¹å™¨: $CONTAINER_NAME ..."
    docker restart $CONTAINER_NAME
    
    echo "ğŸ‰ å‘å¸ƒæˆåŠŸï¼å®¹å™¨æ­£åœ¨é‡å¯ä¸­..."

  # ä»…åœ¨ä¸»åˆ†æ”¯æäº¤æ—¶è§¦å‘
  only:
    - master
    - main
```









## odoo

odooæ˜¯ä¸€ä¸ªå¼€æºçš„ERPç³»ç»Ÿ

```bash
sudo docker run -d --name db --network odoo-net \
  -e POSTGRES_USER=odoo -e POSTGRES_PASSWORD='P@ssword' -e POSTGRES_DB=postgres \
  -v /data/odoo/pgdata:/var/lib/postgresql/data \
  postgres:15

sudo docker run -d --name odoo --network odoo-net --privileged \
  -p 8069:8069 \
  -e HOST=db -e PORT=5432 -e USER=odoo -e PASSWORD='P@ssword' \
  odoo
```





